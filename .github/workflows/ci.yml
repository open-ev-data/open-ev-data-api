name: CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    fmt:
        name: Formatting
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: rustfmt
            - name: Check formatting
              run: cargo fmt --all -- --check

    clippy:
        name: Linting
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy
            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
            - name: Run clippy
              run: cargo clippy --all-targets --all-features -- -D warnings -A clippy::doc_markdown -A clippy::missing_const_for_fn -A clippy::derive_partial_eq_without_eq -A clippy::missing_errors_doc -A clippy::missing_panics_doc -A clippy::expect_used -A clippy::option_if_let_else -A clippy::use_self

    test:
        name: Tests
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
            - name: Run tests
              run: cargo test --all --all-features

    coverage:
        name: Coverage
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: llvm-tools-preview
            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov
            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
            - name: Generate coverage
              run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v4
              with:
                  files: lcov.info
                  fail_ci_if_error: false

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [fmt, clippy, test]
        steps:
            - uses: actions/checkout@v4
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
            - name: Cache cargo
              uses: Swatinem/rust-cache@v2
            - name: Build release
              run: cargo build --release --all
