name: Release

on:
    workflow_run:
        workflows: ["CI"]
        types: [completed]
        branches: [main]

permissions:
    contents: write
    packages: write

env:
    CARGO_TERM_COLOR: always

jobs:
    release:
        name: Semantic Release
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        outputs:
            new_release_published: ${{ steps.semantic.outputs.new_release_published }}
            new_release_version: ${{ steps.semantic.outputs.new_release_version }}
        steps:
            - name: Generate GitHub App token
              id: generate_token
              uses: tibdex/github-app-token@v2
              with:
                  app_id: ${{ secrets.APP_ID }}
                  private_key: ${{ secrets.PRIVATE_KEY }}

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ steps.generate_token.outputs.token }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  components: llvm-tools-preview

            - name: Install cargo-llvm-cov
              uses: taiki-e/install-action@cargo-llvm-cov

            - name: Cache cargo
              uses: Swatinem/rust-cache@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Install dependencies
              run: npm ci

            - name: Semantic Release
              id: semantic
              env:
                  GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
                  DOCKER_REGISTRY_USER: ${{ github.repository_owner }}
                  DOCKER_REGISTRY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
              run: npx semantic-release

    build-extra-platforms:
        name: Build ${{ matrix.target }} - ${{ matrix.package }}
        needs: release
        if: needs.release.outputs.new_release_published == 'true'
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # Windows binaries
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      package: ev-server
                      artifact: ev-server.exe
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                      package: ev-etl
                      artifact: ev-etl.exe
                    # macOS ARM binaries
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      package: ev-server
                      artifact: ev-server
                    - target: aarch64-apple-darwin
                      os: macos-latest
                      package: ev-etl
                      artifact: ev-etl
                    # macOS Intel binaries
                    - target: x86_64-apple-darwin
                      os: macos-13
                      package: ev-server
                      artifact: ev-server
                    - target: x86_64-apple-darwin
                      os: macos-13
                      package: ev-etl
                      artifact: ev-etl
        steps:
            - uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Build
              run: cargo build --release --target ${{ matrix.target }} -p ${{ matrix.package }}

            - name: Archive (Unix)
              if: runner.os != 'Windows'
              run: |
                  cd target/${{ matrix.target }}/release
                  tar -czvf ${{ matrix.package }}-${{ matrix.target }}.tar.gz ${{ matrix.artifact }}
                  mv ${{ matrix.package }}-${{ matrix.target }}.tar.gz ../../../

            - name: Archive (Windows)
              if: runner.os == 'Windows'
              shell: pwsh
              run: |
                  Compress-Archive -Path target/${{ matrix.target }}/release/${{ matrix.artifact }} -DestinationPath ${{ matrix.package }}-${{ matrix.target }}.zip

            - name: Upload to Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ needs.release.outputs.new_release_version }}
                  files: |
                      ${{ matrix.package }}-${{ matrix.target }}.tar.gz
                      ${{ matrix.package }}-${{ matrix.target }}.zip
              continue-on-error: true
